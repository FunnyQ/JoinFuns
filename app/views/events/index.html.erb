<!-- map canvas -->
<div class="map-canvas" id="map"></div>

<!-- user position marker -->
<%= render partial: 'partials/user_position_marker' %>

<!-- panels -->
<%= render partial: 'partials/filter_panel' %>

<!-- dm panels -->
<%= render partial: 'partials/dm_panel' %>

<!-- shorten_dm panels -->
<%= render partial: 'partials/shorten_dm' %>

<%= content_for :handwrite_js do %>
  <script>
    $(".dm-panel-wrapper").hide();
      handler = Gmaps.build('Google');
      handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){

      if(navigator.geolocation)
      navigator.geolocation.getCurrentPosition(getpos);

      function getpos(pos){
        var pin = handler.addMarker({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        });
        handler.map.centerOn(pin);
      }


      markers_json = <%=raw @hash.to_json %>;
      markers = _.map(markers_json, function(marker_json){
        marker = handler.addMarker(marker_json);
        _.extend(marker, marker_json);
        return marker;
      });

      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
      //handler.getMap().setZoom(13)



      // Add event listener on marker click
      for (var i = 0; i <  markers.length; ++i) {
        var marker = markers[i];
        google.maps.event.addListener(marker.serviceObject, 'click', onMarkerClick(marker, event));
      }

      function onMarkerClick(marker, event){
        return function(event){
          // On marker click, make AJAX request on "flats#show"
          //$.get("/flats/" + marker.id);

          $.ajax({
            url: '/events/'+marker.id+'.js',
            type: 'GET',
            data: {

            },
            error: function(xhr) {
              alert('Ajax request 發生錯誤');
            },
            success: function(response) {
              console.log(response)
              $(".dm-panel-wrapper").show()


            }
          })
        }
      }

    })

    $(document).ready(JoinFuns.initialMap());
  <script>
    $(document).ready(JoinFuns.initialMap());
    $(document).ready(JoinFuns.initMaterialSelect());
    $(document).ready(JoinFuns.filterTriggerInit());
    $(document).ready(JoinFuns.dmPanelInit());
  </script>
<% end %>
